<!DOCTYPE html>
<html>
 <body>
  <title>
   XIV Interactive Demo!
  </title>
  <link href="style.css" rel="stylesheet"/>
  <meta charset="utf-8"/>
  <h1>
   XIV Interactive Demo
  </h1>
  <h2>
   Counter Example
  </h2>
  <div class="demo-box" x-data='{ "count": 0, "message": "Hello XIV!" }'>
   <p>
    Current count is:
    <b x-text="count">
    </b>
   </p>
   <button x-on:click="count++">
    Increment
   </button>
   <p>
    Message is:
    <span x-text="message">
    </span>
   </p>
   <input type="text" x-on:input="message = event.target.value"/>
  </div>
  <script>
   const XIV = {
    init() {
        document.querySelectorAll('[x-data]').forEach(el => {
            this.initComponent(el);
        });
    },

    initComponent(el) {
        const dataString = el.getAttribute('x-data');
        let data = {};
        try {
            data = (new Function(`return ${dataString}`))();
        } catch (e) {
            console.error('XIV Error: Invalid JSON in x-data attribute', e, dataString);
            return;
        }

        const scope = this.reactive(el, data);
        this.registerEvents(el, scope);
    },

    reactive(el, data) {
        const scope = new Proxy(data, {
            set: (target, key, value) => {
                target[key] = value;
                this.update(el, target);
                return true;
            }
        });
        // Initial UI update based on initial data
        this.update(el, scope);
        return scope;
    },

    update(el, scope) {
        // Update all elements with x-text
        el.querySelectorAll('[x-text]').forEach(textEl => {
            const key = textEl.getAttribute('x-text');
            if (key in scope) {
                textEl.textContent = scope[key];
            }
        });
    },

    registerEvents(el, scope) {
        // Find all elements with x-on attributes within the component
        const elementsWithEvents = [el, ...el.querySelectorAll('*')];
        elementsWithEvents.forEach(node => {
            for (const attr of node.attributes) {
                if (attr.name.startsWith('x-on:')) {
                    const event = attr.name.substring(5);
                    const expression = attr.value;
                    
                    node.addEventListener(event, () => {
                        try {
                            // Execute the expression within the scope of the component's data
                            const func = new Function('scope', `with(scope) { ${expression} }`);
                            func(scope);
                        } catch (e) {
                            console.error(`XIV Error: Failed to execute expression "${expression}"`, e);
                        }
                    });
                }
            }
        });
    }
};

document.addEventListener('DOMContentLoaded', () => {
    XIV.init();
});
  </script>
 </body>
</html>
